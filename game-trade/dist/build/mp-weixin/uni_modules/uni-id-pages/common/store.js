"use strict";var e=require("../../../common/vendor.js");const o=e.rn.importObject("uni-id-co"),n=e.rn.database().collection("uni-id-users");let t=e.index.getStorageSync("uni-id-pages-userInfo")||{};console.log(t);const s={userInfo:t,hasLogin:0!=Object.keys(t).length};console.log("data",s);const i={async updateUserInfo(o=!1){if(o)n.where("_id==$env.uid").update(o).then((n=>{console.log(n),n.result.updated?(e.index.showToast({title:"更新成功",icon:"none"}),this.setUserInfo(o)):e.index.showToast({title:"没有改变",icon:"none"})}));else try{let e=await n.where("'_id' == $cloudEnv_uid").field("mobile,nickname,username,email,avatar_file").get();console.log("fromDbData",e.result.data),this.setUserInfo(e.result.data[0])}catch(t){this.setUserInfo({},{cover:!0}),console.error(t.message,t.errCode)}},async setUserInfo(o,{cover:n}={cover:!1}){console.log("set-userInfo",o);let t=n?o:Object.assign(r.userInfo,o);return r.userInfo=Object.assign({},t),r.hasLogin=0!=Object.keys(r.userInfo).length,console.log("store.userInfo",r.userInfo),e.index.setStorage({key:"uni-id-pages-userInfo",data:r.userInfo}),o},async logout(){var n,t;await o.logout(),e.index.removeStorageSync("uni_id_token"),e.index.setStorageSync("uni_id_token_expired",0),e.index.redirectTo({url:`/${null!=(t=null==(n=e.pagesJson.uniIdRouter)?void 0:n.loginPage)?t:"uni_modules/uni-id-pages/pages/login/login-withoutpwd"}`}),e.index.$emit("uni-id-pages-logout"),this.setUserInfo({},{cover:!0})},loginSuccess(o={}){const{showToast:n=!0,toastText:t="登录成功",autoBack:s=!0,uniIdRedirectUrl:i=""}=o;if(console.log({toastText:t,autoBack:s}),n&&e.index.showToast({title:t,icon:"none"}),this.updateUserInfo(),e.index.$emit("uni-id-pages-login-success"),s){let o=0,n=getCurrentPages();if(n.forEach(((e,t)=>{"login"==n[n.length-t-1].route.split("/")[3]&&o++})),i)return e.index.reLaunch({url:i});if(o){const o=e.pagesJson.pages[0];return e.index.reLaunch({url:`/${o.path}`})}e.index.navigateBack({delta:o})}}},r=e.reactive(s);exports.mutations=i;
