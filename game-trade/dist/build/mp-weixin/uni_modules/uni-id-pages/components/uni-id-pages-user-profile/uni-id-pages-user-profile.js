"use strict";var e=require("../../../../common/vendor.js");const o=e.pn.database().collection("uni-id-users");let t="";const a={emits:["next"],data:()=>({}),methods:{async open(e){t=e,this.$refs.popup.open()},async getUserProfile(){e.index.showLoading();let o=await new Promise((o=>{e.index.getUserProfile({desc:"用于设置账户昵称和头像",complete:e=>{console.log("getUserProfile:",e),o(e)}})}));if("getUserProfile:ok"!=o.errMsg)return this.closeMe();let{avatarUrl:a,nickName:s}=o.userInfo,i=await new Promise((o=>{e.index.downloadFile({url:a,success:e=>{200===e.statusCode&&o(e.tempFilePath),o()},fail:e=>{console.error(e)},complete:e=>{}})}));const n=i.split(".").pop()||"jpg",r="user/avatar/"+t+"/"+Date.now()+"-avatar."+n;let l={nickname:s,avatar_file:{name:r,extname:"jpg",url:(await e.pn.uploadFile({filePath:i,cloudPath:r,fileType:"image"})).fileID}};this.doUpdate(l,(()=>{this.$refs.popup.close()}))},closeMe(o){e.index.showLoading(),this.doUpdate({nickname:"匿名微信用户"},(()=>{e.index.hideLoading(),this.$refs.popup.close()}))},doUpdate(t,a){o.where("_id==$env.uid").update(t).then((e=>{a(e)})).catch((o=>{e.index.showModal({content:o.message||"请求服务失败",showCancel:!1}),a(o)})).finally((()=>{this.$emit("next"),e.index.hideLoading()}))}}};if(!Array){e.resolveComponent("uni-popup")()}Math;var s=e._export_sfc(a,[["render",function(o,t,a,s,i,n){return{a:e.o(((...e)=>n.closeMe&&n.closeMe(...e))),b:e.o(((...e)=>n.getUserProfile&&n.getUserProfile(...e))),c:e.sr("popup","54edbaa6-0"),d:e.p({type:"bottom"})}}],["__scopeId","data-v-54edbaa6"]]);wx.createComponent(s);
